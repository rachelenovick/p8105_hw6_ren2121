---
title: "p8105_hw6_ren2121"
output: github_document
date: "2025-11-29"
---

```{r}
library(tidyverse)
library(p8105.datasets)
library(modelr)
```


## Problem 1

Reading in the dataset from github:

```{r}
url = "https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv"

homicides = read_csv(url)
```

Creating a city_state variable, and a binary variable indicating whether the homicide is solved. Omitting cities that do not report victim race, limiting the analysis by race, and converting age to a numeric variable.

```{r}
homicides =
  homicides |> 
  mutate(
    city_state = paste(city, state, sep = ", "),
    solved = case_when(
      disposition %in% c("Closed without arrest", "Open/No arrest") ~ 0,
      disposition == "Closed by arrest" ~ 1
    ),
    victim_age = parse_number(as.character(victim_age))
  ) |> 
  filter(
    !city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL"),
    victim_race %in% c("White", "Black")
    )
  
```

Fitting a logistic regression, for the city of Baltimore, with resolved vs. unresolved as the outcome and victim age, sex and race as predictors. Obtaining the estimate and confidence interval of the adjusted odds ratio for solving homicides comparing male victims to female victims, keeping all other variables fixed.

```{r}
baltimore = 
  homicides |> 
  filter(city_state == "Baltimore, MD")

crime_fit = glm(
  solved ~ victim_age + victim_sex + victim_race, 
  data = baltimore,
  family = binomial) #specifies logistic regression

crime_fit |> 
  broom::tidy(exponentiate = TRUE, conf.int = TRUE) |> 
  select(term, estimate, conf.low, conf.high) |> 
  filter(term == "victim_sexMale") |> 
  knitr::kable()
```

The odds of a homicide being solved for male victims is 0.426 times the odds of a homicide being solved for female victims, adjusting for age and race.

Writing a function to run glm for each of the cities in the dataset.

```{r}
glm_crime = function(df) {
  glm(
    solved ~ victim_age + victim_sex + victim_race, 
    data = df,
    family = binomial
  )
}

city_or_results =
  homicides |>
  nest(data = -city_state) |>
  mutate(
    fits = map(data, \(df) glm(
      solved ~ victim_age + victim_sex + victim_race,
      data = df,
      family = binomial
    )),
    results = map(fits, broom::tidy, exponentiate = TRUE, conf.int = TRUE)
  ) |>
  select(city_state, results) |> 
  unnest(results) |> 
  filter(term == "victim_sexMale") |>
  select(city_state, estimate, conf.low, conf.high)
```

Creating a plot of ORs and CIs for each city.

```{r}
city_or_results |> 
  mutate(
    city_state = fct_reorder(city_state, estimate)
  ) |> 
  ggplot(aes(x = city_state, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
  coord_flip() +
  labs(x = "City",
       y = "Adjusted Odds Ratio (Male vs Female)",
    title = "Adjusted Odds Ratios for Solving Homicides by Victim Sex") +
  theme_minimal()

```

In the majority of cities, the odds of a homicide being solved is lower for male victims compared to female victims, adjusting for age and race. In New York, NY, male victims have the lowest odds relative to female victims of a homicide being solved. In Albuquerque, NM, male victims have the greatest odds compared to female victims of a homicide being solved, followed by Stockton, CA, then Fresno, CA.

## Problem 2

Reading in the weather dataset.

```{r}
data("weather_df")
```

Bootstrapping 5000 samples and producing quantile estimates.

```{r}

set.seed(123)

bootstrap_results =
  weather_df |> 
  bootstrap(n = 5000) |> 
  mutate(
    df = map(strap, as_tibble),
    fits = map(df, \(df) lm(tmax ~ tmin + prcp, data = df)),
    r2 = map(fits, \(mod) broom::glance(mod) |> pull(r.squared)),
    beta_ratio = map(fits, \(mod) {
      broom::tidy(mod) |> 
        filter(term %in% c("tmin", "prcp")) |> 
        summarize(ratio = estimate[term == "tmin"] / estimate[term == "prcp"]) |> 
        pull(ratio)
    })
  ) |> 
  select(.id, r2, beta_ratio) |> 
  unnest(cols = c(r2, beta_ratio))

```


